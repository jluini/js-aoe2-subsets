<html>
<script>
    function BinarySeq(bools) {
        this.bools = bools;
        this.length = bools.length;
    }

    BinarySeq.zero = function(size) {
        var arr = new Array(size);
        
        for(var i = 0; i < size; i++) {
            arr[i] = false;
        }
        
        return new BinarySeq(arr);
    };

    BinarySeq.a_and_b = function(a, b, bNegated) {
        var arr = [];

        for(var i = 0; i < a.length; i++) {
            var av = a.isOn(i);
            var bv = b.isOn(i);
            
            var value = av && (bNegated ? !bv : bv);
            
            arr.push(value);
        }

        return new BinarySeq(arr);
    };

    BinarySeq.prototype = {
        isOn: function(e) {
            return this.bools[e];
        },

        setBit: function(e) {
            this.bools[e] = true;
        },

        zero: function() {
            for(var e = 0; e < this.length; e++) {
                if(this.isOn(e)) {
                    return false;
                }
            }
            return true;
        },

        meetsConditions: function(conditions) {
            var positiveConditions = conditions[0];
            var negativeConditions = conditions[1];
            
            if(!BinarySeq.a_and_b(positiveConditions, this, true).zero()) {
                return false;
            }

            if(!BinarySeq.a_and_b(negativeConditions, this, false).zero()) {
                return false;
            }

            return true;
        }
    };

    function Stats(config) {
        this.config = config;
        this._generate();
    }

    Stats.prototype = {
        numberOfElements: function() {
            return this.config.elementKeywords.length;
        },

        elementKeyword: function(elementIndex) {
            return this.config.elementKeywords[elementIndex];
        },

        numberOfProperties: function() {
            return this.propertyKeys.length;
        },
        
        isPropertyOn: function(p, e) {
            // return this.config.properties[p].isOn(e);
            return this.propertyValues[p].isOn(e);
        },

        whichCivs: function(humanConditionList) {
            var conditionHashes = this.humanConditionListToHashes(humanConditionList);
            
            return this._whichCivs(conditionHashes);
        },

        _whichCivs: function(conditionHashes) {
            var out = []
            
            for(var e = 0; e < this.numberOfElements(); e++) {
                if(this._meetsConditions(e, conditionHashes)) {
                    out.push(this.elementKeyword(e));
                }
            }

            return out;
        },

        _meetsConditions: function(elementIndex, conditionHashes) {
            var positiveHash = conditionHashes[0];

            var civHash = this.elementData[elementIndex];

            // var op = BinarySeq.a_and_not_b(positiveHash, civHash);
            // return op.zero();

            return civHash.meetsConditions(conditionHashes);
        },

        humanConditionListToHashes: function(humanConditionList) {
            var out = [BinarySeq.zero(this.numberOfProperties()), BinarySeq.zero(this.numberOfProperties())];
            
            for(var h = 0; h < humanConditionList.length; h++) {
                var humanCondition = humanConditionList[h];
                var regexp = /(\+|\-|)(.+)/g;
                var match = regexp.exec(humanCondition);

                var negated = match[1] == "-";
                
                var propertyKey = match[2];
                var propertyIndex = this.propertyKeyToIndex(propertyKey);

                out[negated ? 1 : 0].setBit(propertyIndex);
            }

            return out;
        },

        propertyKeyToIndex: function(propertyKey) {
            var index = this.propertyKeys.indexOf(propertyKey);

            if(index < 0) {
                throw "Property key '" + propertyKey + "' not found";
            }

            return index;
        },

        // private

        _generate: function() {
            this._generatePropertiesFromList(this.config.propertyValues);
            this._generateElementDataFromProperties();
        },
        
        _generatePropertiesFromList: function(list) {
            var numberOfProperties = list.length;
            
            this.propertyKeys = new Array(numberOfProperties);
            this.propertyValues = new Array(numberOfProperties);
            
            for(var p = 0; p < numberOfProperties; p++) {
                this.propertyKeys[p] = list[p][0];
                this.propertyValues[p] = list[p][1];
            }
        },
        
        _generateElementDataFromProperties: function() {
            this.elementData = [];

            for(var e = 0; e < this.numberOfElements(); e++) {
                var newData = [];

                for(var p = 0; p < this.numberOfProperties(); p++) {
                    newData.push(this.isPropertyOn(p, e));
                }
                
                this.elementData.push(new BinarySeq(newData));
            }
        }
    };

    function allThese(civs, which) {
        return listOf(civs, which, false);
    }
    
    function allBut(civs, which) {
        return listOf(civs, which, true);
    }
    
    function listOf(civs, which, negate) {
        var s = [];

        for(var i = 0; i < civs.length; i++) {
            var value = which.includes(civs[i]);
            s.push(negate ? !value : value);
        }
        
        return new BinarySeq(s);
    }
    
    function prueba(stats) {
        console.log("Probando...");

        console.log("Civs con ballesteros pero sin caÃ±ones:");
        
        console.log(stats.whichCivs(["+crossbowman", "-bbc"]));
    }

    var civs = [
        "aztecs",      // 0
        "berbers",     // 1
        "bohemians",   // 2
        "britons",     // 3
        "bulgarians",  // 4
        "burgundians", // 5
        "burmese",     // 6
        "byzantines",  // 7
        "celts",       // 8
        "chinese",     // 9
        "cumans",      // 10
        "ethiopians",  // 11
        "franks",      // 12
        "goths",       // 13
        "huns",        // 14
        "incas",       // 15
        "indians",     // 16
        "italians",    // 17
        "japanese",    // 18
        "khmer",       // 19
        "koreans",     // 20
        "lithuanians", // 21
        "malay",       // 22
        "malians",     // 23
        "magyars",     // 24
        "mayans",      // 25
        "mongols",     // 26
        "persians",    // 27
        "poles",       // 28
        "portuguese",  // 29
        "saracens",    // 30
        "sicilians",   // 31
        "slavs",       // 32
        "spanish",     // 33
        "tatars",      // 34
        "teutons",     // 35
        "turks",       // 36
        "vietnamese",  // 37
        "vikings"      // 38
    ];
    
    var config = {
        // numElements: 39,
        elementKeywords: civs,
        
        propertyValues: [
            // barracks
            
            ["ths",                 allBut(civs, ["persians"])],
            ["champion",            allBut(civs, ["bulgarians", "ethiopians", "huns", "khmer", "malay", "mayans", "persians", "tatars"])],
            
            ["pikeman",             allBut(civs, ["turks"])],
            ["halberdier",          allBut(civs, ["aztecs", "berbers", "italians", "malians", "mongols", "poles", "saracens", "turks", "vikings"])],
            
            ["ew",                  allThese(civs, ["aztecs", "incas", "mayans"])],
            
            ["squires",             allBut(civs, ["celts", "khmer", "magyars", "portuguese"])],
            ["supplies",            allBut(civs, ["burgundians", "chinese", "cumans", "goths", "huns", "khmer", "lithuanians", "mayans", "mongols", "tatars"])],
            ["arson",               allBut(civs, ["goths"])],
            
            
            // range
            
            ["crossbowman",         allBut(civs, ["bulgarians", "spanish"])],
            ["arbalester",          allBut(civs, ["berbers", "bulgarians", "burgundians", "burmese", "celts", "cumans", "franks", "goths", "huns", "indians", "lithuanians", "persians", "slavs", "spanish", "tatars", "teutons", "turks"])],
            
            ["elite skirmisher",    allBut(civs, ["turks"])],
            
            ["ca",                  allBut(civs, ["aztecs", "bohemians", "incas", "mayans"])],
            ["hca",                 allBut(civs, ["aztecs", "bohemians", "burgundians", "incas", "italians", "malay", "mayans", "portuguese", "sicilians", "teutons", "vikings"])],
            
            ["hc",                  allThese(civs, ["berbers", "bohemians", "burgundians", "byzantines", "franks", "goths", "indians", "italians", "japanese", "khmer", "koreans", "lithuanians", "malians", "persians", "portuguese", "saracens", "spanish", "tatars", "teutons", "turks"])],
            
            ["thumb ring",          allBut(civs, ["aztecs", "bohemians", "britons", "burgundians", "burmese", "celts", "franks", "goths", "khmer", "sicilians", "slavs", "teutons", "vikings"])],
            ["parthian tactics",    allThese(civs, ["bulgarians", "burmese", "cumans", "huns", "indians", "japanese", "khmer", "magyars", "mongols", "persians", "saracens", "tatars", "turks"])],
            
            
            // stable
            
            // TODO: units
            
            ["bloodlines",          allBut(civs, ["aztecs", "bohemians", "britons", "burgundians", "byzantines", "celts", "ethiopians", "franks", "incas", "koreans", "malay", "mayans", "vikings"])],
            ["husbandry",           allBut(civs, ["aztecs", "cumans", "incas", "mayans", "teutons", "vikings"])],
            
            
            // blacksmith
            
            // TODO
            ["leather archer armor", allBut(civs, ["burmese"])],
            ["ring archer armor",   allBut(civs, ["aztecs", "bulgarians", "burgundians", "burmese", "celts", "franks", "huns", "mongols", "poles", "sicilians"])],
            ["bracer",              allBut(civs, ["celts", "cumans", "franks", "malians", "persians", "slavs", "teutons"])],
            
            
            // others
            // TODO
            
            ["bbc",                 allBut(civs, ["aztecs", "britons", "bulgarians", "celts", "chinese", "cumans", "huns", "incas", "japanese", "khmer", "magyars", "mayans", "mongols", "sicilians", "slavs", "tatars", "vikings"])],
            
            ["heresy",              BinarySeq.zero(civs.length)], // TODO
        ],
        
        
        // //numProperties: 
        // propertyKeywords: [
            
            
            
            
            
        //     "crossbowman",
        //     "bbc",
        //     "heresy"
        // ],

        // properties: [
        //     // crossbowman
        //     allBut(civs, ["bulgarians", "spanish"]),

        //     // bbc
        //     allBut(civs, [
        //         "aztecs",
        //         "britons",
        //         "bulgarians",
        //         "celts",
        //         "chinese",
        //         "cumans",
        //         "huns",
        //         "incas",
        //         "japanese",
        //         "khmer",
        //         "magyars",
        //         "mayans",
        //         "mongols",
        //         "sicilians",
        //         "slavs",
        //         "tatars",
        //         "vikings"
        //     ]),
            
        //     // heresy TODO
        //     BinarySeq.zero(civs.length),
        // ]
    };

    var stats = new Stats(config);
    window.stats = stats;
    prueba(stats);
    
</script>
</html>
